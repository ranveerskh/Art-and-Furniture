<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Business Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .loss {
      background-color: #ffd6d6;
    }
    .profit {
      background-color: #d6ffd6;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    select {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <h1>Business Tracker</h1>

  <label for="filter">Filter Activity Log:</label>
  <select id="filter">
    <option value="all">All</option>
    <option value="last10days">Last 10 Days</option>
    <option value="monthly">This Month</option>
    <option value="expenses">Only Expenses</option>
    <option value="payments">Only Payments</option>
  </select>

  <h2>Activity Log</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Type</th>
        <th>Item Name</th>
        <th>Item Number</th>
        <th>Amount</th>
        <th>Description</th>
        <th>User</th>
        <th>Added By</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="logTableBody"></tbody>
  </table>

  <h3 id="settlementDiv"></h3>
  <div id="monthlyProfit"></div>
  <div id="yearlyProfit"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCUv0HLUP3bto3U8R4a7tcvKwVOr1MQLd0",
      authDomain: "business-tracker-2a0b1.firebaseapp.com",
      projectId: "business-tracker-2a0b1",
      storageBucket: "business-tracker-2a0b1.appspot.com",
      messagingSenderId: "334405601689",
      appId: "1:334405601689:web:46a847d394c1c7f145d1a2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const logTableBody = document.getElementById("logTableBody");
    const settlementDiv = document.getElementById("settlementDiv");
    const monthlyProfitDiv = document.getElementById("monthlyProfit");
    const yearlyProfitDiv = document.getElementById("yearlyProfit");

    function loadLogs() {
      const q = db.collection("businessLogs").orderBy("timestamp", "desc");
      const selectedFilter = document.getElementById("filter").value;

      q.onSnapshot((snapshot) => {
        logTableBody.innerHTML = "";
        let ranveerBalance = 0;
        let amanBalance = 0;
        let monthlyProfit = 0;
        let yearlyProfit = 0;

        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const id = docSnap.id;
          const date = data.timestamp?.toDate();
          const time = date?.toLocaleString() ?? "Unknown";

          // Filter logic
          if (selectedFilter === "last10days" && date) {
            const tenDaysAgo = new Date();
            tenDaysAgo.setDate(now.getDate() - 10);
            if (date < tenDaysAgo) return;
          }

          if (selectedFilter === "monthly" && date) {
            if (date.getMonth() !== currentMonth || date.getFullYear() !== currentYear) return;
          }

          if (selectedFilter === "expenses" && data.type !== "Expense") return;
          if (selectedFilter === "payments" && data.type !== "Payment") return;

          // Balance logic
          if (data.type === "Expense") {
            if (data.addedBy === "Ranveer") amanBalance -= data.amount / 2;
            else ranveerBalance -= data.amount / 2;

            if (date.getMonth() === currentMonth) monthlyProfit -= data.amount;
            if (date.getFullYear() === currentYear) yearlyProfit -= data.amount;
          } else if (data.type === "Payment") {
            if (data.addedBy === "Ranveer") amanBalance += data.amount / 2;
            else ranveerBalance += data.amount / 2;

            if (date.getMonth() === currentMonth) monthlyProfit += data.amount;
            if (date.getFullYear() === currentYear) yearlyProfit += data.amount;
          }

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${time}</td>
            <td>${data.type}</td>
            <td>${data.itemName}</td>
            <td>${data.itemNumber}</td>
            <td>₹${data.amount.toFixed(2)}</td>
            <td>${data.description}</td>
            <td>${data.user}</td>
            <td>${data.addedBy}</td>
            <td><button onclick="deleteEntry('${id}')">Delete</button></td>
          `;
          logTableBody.appendChild(row);
        });

        // Show Settlement
        const balance = ranveerBalance - amanBalance;
        let message = "";
        if (balance > 0) message = `Aman owes Ranveer ₹${Math.abs(balance).toFixed(2)}`;
        else if (balance < 0) message = `Ranveer owes Aman ₹${Math.abs(balance).toFixed(2)}`;
        else message = "All Settled!";
        settlementDiv.textContent = message;

        // Show Monthly and Yearly Profit/Loss
        monthlyProfitDiv.innerHTML = `<h3 class="${monthlyProfit < 0 ? 'loss' : 'profit'}">Monthly ${monthlyProfit < 0 ? 'Loss' : 'Profit'}: ₹${Math.abs(monthlyProfit).toFixed(2)}</h3>`;
        yearlyProfitDiv.innerHTML = `<h3 class="${yearlyProfit < 0 ? 'loss' : 'profit'}">Yearly ${yearlyProfit < 0 ? 'Loss' : 'Profit'}: ₹${Math.abs(yearlyProfit).toFixed(2)}</h3>`;
      });
    }

    function deleteEntry(id) {
      if (confirm("Are you sure you want to delete this entry?")) {
        db.collection("businessLogs").doc(id).delete();
      }
    }

    document.getElementById("filter").addEventListener("change", loadLogs);
    loadLogs(); // Initial load
  </script>
</body>
</html>
