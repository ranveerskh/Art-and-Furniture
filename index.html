<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Tracker</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8hNmjkXT1SaCFJ0F7R2UvVoLpSZc3fKM",
      authDomain: "epoxyresin-60ea7.firebaseapp.com",
      projectId: "epoxyresin-60ea7",
      storageBucket: "epoxyresin-60ea7.firebasestorage.app",
      messagingSenderId: "591026708184",
      appId: "1:591026708184:web:0b9431b279a5b0026ec1ad"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userLabel = document.getElementById("user");
    const expenseForm = document.getElementById("expense-form");
    const logList = document.getElementById("log-list");
    const logoutBtn = document.getElementById("logout");

    let currentUser = null;

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        userLabel.textContent = `Logged in as: ${user.email}`;
        loadLogs();
      } else {
        window.location.href = "/login.html"; // Redirect to login page
      }
    });

    expenseForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const type = document.getElementById("type").value;
      const amount = parseFloat(document.getElementById("amount").value);
      const description = document.getElementById("description").value;
      const userName = currentUser.email.includes("ranveer") ? "Ranveer" : "Aman";

      await addDoc(collection(db, "businessLogs"), {
        user: userName,
        type,
        amount,
        description,
        timestamp: serverTimestamp()
      });

      expenseForm.reset();
    });

    function loadLogs() {
      const q = query(collection(db, "businessLogs"), orderBy("timestamp", "desc"));
      onSnapshot(q, (snapshot) => {
        logList.innerHTML = "";
        snapshot.forEach((doc) => {
          const data = doc.data();
          const li = document.createElement("li");
          li.textContent = `${data.timestamp?.toDate().toLocaleString()} - ${data.user} added ${data.type} of $${data.amount} (${data.description})`;
          logList.appendChild(li);
        });
      });
    }

    logoutBtn.onclick = () => signOut(auth);
  </script>
</head>
<body>
  <h1>Business Tracker</h1>
  <p id="user">Loading...</p>
  <form id="expense-form">
    <label for="type">Type:</label>
    <select id="type">
      <option value="Expense">Expense</option>
      <option value="Payment">Payment</option>
    </select><br>
    <label for="amount">Amount:</label>
    <input type="number" id="amount" required><br>
    <label for="description">Description:</label>
    <input type="text" id="description" required><br>
    <button type="submit">Add Entry</button>
  </form>
  <h2>Activity Log</h2>
  <ul id="log-list"></ul>
  <button id="logout">Logout</button>
</body>
</html>
